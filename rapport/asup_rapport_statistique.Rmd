---
title: Etude du DPE et des consommations électriques de logements type appartements à Lyon vs Lille
author: "HO Huy, TRAN Cloélia"
date: "2025-11-16"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
install.packages(c("tidyr", "dplyr","ggplot2"), repos = "https://cloud.r-project.org/")
#Les library dont on aura besoin plus tard s'installent ici.
```

## Analyse comparative des consommations électriques selon le DPE des logements type appartement à Lyon et Lille

La performance énergétique d’un logement, mesurée par le Diagnostic de Performance Énergétique (DPE), constitue un indicateur clé de sa consommation d’énergie.

Dans le cadre de ce projet, il s’agira d’analyser dans quelle mesure la classe énergétique influence les consommations électriques moyennes des appartements situés à Lyon et Lille, en distinguant les logements neufs des logements anciens.

À partir de données réelles sur les DPE et les consommations, l’objectif est de mettre en évidence les écarts de performance selon le type de logement et la localisation, à l’aide d’analyses statistiques et de visualisations produites avec R.

```{r import_data, echo=FALSE}
url_lyon <- "https://raw.githubusercontent.com/ndhho/iut_sd2_rshiny_enedis/main/data/clean_csv/logements_69.csv"
url_lille <- "https://raw.githubusercontent.com/ndhho/iut_sd2_rshiny_enedis/main/data/clean_csv/logements_59.csv"

# Import des données
data_lyon <- read.csv2(url_lyon, header = TRUE)
data_lille <- read.csv2(url_lille, header = TRUE)
```
```{r library,echo=FALSE, message=FALSE, warning=FALSE}
#Je choisis d'utiliser message=FALSE et warning=FALSE pour que la page s'affiche proprement sans les messages de chargements de library ou les warnings.

library(dplyr)
#cette library me servira notamment pour les fonctions group_by(), summarise() et mutate() 
library(tidyr)
library(ggplot2)
```

```{r combine_data, echo=FALSE}
#Ajout de la colonne Ville et combinaison des données
data_lyon <- data_lyon %>% mutate(Ville = "Lyon")
data_lille <- data_lille %>% mutate(Ville = "Lille")

#Combinaison des deux jeux de données pour les analyses comparatives des deux villes
data_combined_raw <- rbind(data_lyon, data_lille)
```

### Répartition des Étiquettes DPE pour Lyon et Lille

```{r graph4_univariate, echo=FALSE, message=FALSE, warning=FALSE, fig.width=9, fig.height=5}
# Compter le nombre de logements par DPE et par Ville
data_dpe_counts <- data_combined_raw %>%
  mutate(etiquette_dpe = factor(etiquette_dpe, levels = c("A", "B", "C", "D", "E", "F", "G"))) %>%
  filter(!is.na(etiquette_dpe)) %>% # Retirer les DPE manquants si existants
  group_by(Ville) %>%
  mutate(Total_Ville = n()) %>% # Calculer le total par ville (pour le %)
  group_by(Ville, etiquette_dpe, Total_Ville) %>%
  summarise(
    Nombre = n(), 
    Proportion = Nombre / first(Total_Ville), # Calculer la proportion
    .groups = 'drop'
  )

#création du graphique
ggplot(data_dpe_counts, 
       aes(x = etiquette_dpe, y = Proportion, fill = Ville)) +
  # utilisation de position_dodge pour mettre les diagrammes en barres côte à côte
  geom_bar(stat = "identity", position = position_dodge(width = 0.9)) +
  
  #Ajout des proportions (en %) au-dessus des barres
  geom_text(
    aes(label = scales::percent(Proportion, accuracy = 0.1)), 
    position = position_dodge(width = 0.9),
    vjust = -0.5, #position  verticale du texte
    size = 3
  ) +
  
  labs(
    title = "Répartition des étiquettes DPE (Lyon vs. Lille)",
    x = "Classe DPE",
    y = "Proportion des logements (%)",
    fill = "Ville"
  ) +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_manual(values = c("Lyon" = "#0047AB", "Lille" = "#FFA500")) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))
```

Ce graphique nous montre que la classe C représente la plus grande proportion de logements à Lyon et à Lille. En revanche, on observe que Lille possède plus de logements classés D, E, F que Lyon, ce qui pourrait signaler un défi plus important de rénovation énergétique à Lille.

### 1️⃣ KPI 1 : Consommation moyenne par logement et par classe DPE

```{r kpi1, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
# Je calcule mon KPI ici pour Lyon et pour Lille
kpi1_lyon <- data_lyon %>%
  group_by(flag, etiquette_dpe) %>% #Je group by flag car c'est le logement et la classe DPE qui m'intéressent pour ce KPI
  summarise(conso_moyenne = mean(cout_total_5_usages, na.rm = TRUE))

kpi1_lille <- data_lille %>%
  group_by(flag, etiquette_dpe) %>%
  summarise(conso_moyenne = mean(cout_total_5_usages, na.rm = TRUE))

#J'utilise cat() pour écrire mes deux titres, puis print(knitr::kable()) pour afficher mes deux tables proprement

cat("#### Résultats pour Lyon\n")
print(knitr::kable(kpi1_lyon, caption = "Consommation moyenne par DPE à Lyon"))

#Espace pour séparer les deux tables et que ce soit + lisible
cat("\n\n") 

cat("#### Résultats pour Lille\n")
print(knitr::kable(kpi1_lille, caption = "Consommation moyenne par DPE à Lille"))
```

### Représentation graphique KPI 1

```{r graph1, echo=FALSE, message=FALSE, warning=FALSE}

#Préparation des données pour le graphique 1, sachant que j'utilise aussi les KPI 1
data_combined_kpi1 <- rbind(
  kpi1_lyon %>% mutate(Ville = "Lyon"),
  kpi1_lille %>% mutate(Ville = "Lille")
)

#Graphique 1 : Consommation Moyenne par DPE et Ville
ggplot(data_combined_kpi1, 
       aes(x = etiquette_dpe, y = conso_moyenne, fill = Ville)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8)) +
  # Une facette par type de logement (neuf/existant) pour un graphique plus riche
  facet_wrap(~ flag) + 
  labs(
    title = "Consommation moyenne par DPE, Type de logement et Ville",
    x = "Classe DPE",
    y = "Coût Total des 5 Usages Moyen (€)"
  ) +
  theme_minimal() +
  scale_fill_manual(values = c("Lyon" = "#0047AB", "Lille" = "#FFA500"))
```

**Interprétation :** Le graphique montre une corrélation très forte entre la dégradation de la classe DPE et l'augmentation de la consommation pour les logements existants, avec un pic extrême pour la classe G à Lyon (plus de 2000 €). Pour les logements neufs, la consommation est globalement faible pour les classes A, B, C et D.

### 2️⃣ KPI 2 : Consommation moyenne au m²

```{r kpi2, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
# On calcule la consommation au m² avant de faire la moyenne
kpi2_lyon <- data_lyon %>%
  mutate(conso_m2 = cout_total_5_usages / surface_habitable_logement) %>%
  group_by(flag, etiquette_dpe) %>%
  summarise(conso_m2_moy = mean(conso_m2, na.rm = TRUE))

kpi2_lille <- data_lille %>%
  mutate(conso_m2 = cout_total_5_usages / surface_habitable_logement) %>%
  group_by(flag, etiquette_dpe) %>%
  summarise(conso_m2_moy = mean(conso_m2, na.rm = TRUE))

cat("#### Résultats pour Lyon\n")
print(knitr::kable(kpi2_lyon, caption = "Consommation moyenne au m² à Lyon"))

cat("\n\n") 

cat("#### Résultats pour Lille\n")
print(knitr::kable(kpi2_lille, caption = "Consommation moyenne au m² à Lille"))
```

### Représentation graphique KPI 2

```{r graph2, echo=FALSE, message=FALSE, warning=FALSE, fig.width=9, fig.height=5}
# Combinaison des KPI 2 de Lyon et Lille
data_combined_kpi2 <- rbind(
  kpi2_lyon %>% mutate(Ville = "Lyon"),
  kpi2_lille %>% mutate(Ville = "Lille")
)

# Graphique : Diagramme en barres groupées avec facette par Ville
ggplot(data_combined_kpi2, 
       aes(x = etiquette_dpe, y = conso_m2_moy, fill = flag)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8)) +
  facet_wrap(~ Ville) + 
  labs(
    title = "Consommation Énergétique Moyenne par m² (Neuf vs Existant)",
    x = "Classe DPE",
    y = "Coût Moyen par m² (€/m²)",
    fill = "Type de Logement"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))
```

**Interprétation : ** Le graphique illustre une forte relation entre la classe DPE et la consommation énergétique moyenne par m². Pour les logements existants, la consommation augmente grandement à mesure que la performance énergétique se dégrade, atteignant un maximum pour la classe G, surtout à Lyon (près de 50 €/m²). Les logements neufs présentent des coûts bien plus faibles et stables jusqu’à la classe E.

```{r graph_mode_chauffage, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=5}

data_source <- data_combined_raw 

data_cleaned_energy <- data_source %>%

  rename(mode_chauffage = type_energie_principale_chauffage) %>%
  
  # Création des catégories (Bois, Electricité, Gaz Naturel, Autres)
  mutate(
    mode_chauffage_clean = case_when(
      # Catégorie Bois
      grepl("bois bûches|bois granulés|bois plaquettes d'industrie|bois plaquettes forestières", mode_chauffage, ignore.case = TRUE) ~ "Bois",
      
      # Catégorie Électricité
      grepl("électricité", mode_chauffage, ignore.case = TRUE) ~ "Electricité",
      
      # Catégorie Gaz Naturel
      grepl("gaz naturel", mode_chauffage, ignore.case = TRUE) ~ "Gaz Naturel",
      
      TRUE ~ "Autres énergies" 
    )
  ) %>%
  
  filter(!is.na(mode_chauffage_clean) & mode_chauffage_clean != "")

data_graph_energy <- data_cleaned_energy %>%
  group_by(Ville, mode_chauffage_clean) %>% 
  summarise(Nombre = n(), .groups = 'drop') %>%
  
  # Calculer la proportion de chaque mode de chauffage par ville
  group_by(Ville) %>% 
  mutate(
    Proportion = Nombre / sum(Nombre),
    # Calculer la position cumulative pour placer les étiquettes au milieu de la tranche
    cumul_proportion = cumsum(Proportion) - Proportion / 2 
  ) %>%
  ungroup()

#création de nos 2 camemberts
ggplot(data_graph_energy, 
       aes(x = "", y = Proportion, fill = mode_chauffage_clean)) + 
  
  geom_bar(stat = "identity", width = 1) +
  
  # Transformer en camembert
  coord_polar("y", start = 0) + 
  
  #Séparation par Ville
  facet_wrap(~ Ville) +
  
  #Ajout des étiquettes de pourcentage
  geom_text(
    aes(y = cumul_proportion, label = scales::percent(Proportion, accuracy = 1)),
    color = "white",
    size = 4
  ) +
  
  labs(
    title = "Répartition du Mix Énergétique Global (Lyon vs. Lille)",
    fill = "Mode de Chauffage Principal"
  ) +
  
  theme_void() + 
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    strip.text = element_text(size = 14, face = "bold"),
    legend.title = element_text(face = "bold")
  )
```

**Intrerprétation :** Lille dépend majoritairement du gaz naturel (53 %), suivi par l'électricité (35 %). Inversement, Lyon est principalement chauffée à l'électricité (46 %), le gaz naturel n'y représentant que 35 %. De plus, Lyon utilise davantage les autres énergies comme mode de chauffage principal contrairement à Lille (19% vs 12%).